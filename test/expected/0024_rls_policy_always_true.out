begin;
  set local search_path = '';
  set local pgrst.db_schemas = 'public';
  -- 0 issues - no tables yet
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Create a table with RLS enabled
  create table public.posts(
    id int primary key,
    user_id uuid,
    title text
  );
  alter table public.posts enable row level security;
  -- Create a permissive policy with USING (true) for SELECT - should NOT be flagged
  -- SELECT with (true) is often intentional for public read access
  create policy "allow_all_select"
  on public.posts
  for select
  to authenticated
  using (true);
  -- 0 issues - SELECT with USING (true) is allowed
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Create another policy with 1=1 tautology
  create policy "allow_all_insert"
  on public.posts
  for insert
  to authenticated
  with check (1=1);
  -- 1 issue - only INSERT with WITH CHECK (1=1) is flagged
  select count(*) from lint."0024_rls_policy_always_true";
 count 
-------
     1
(1 row)

  -- Drop the bad policies
  drop policy "allow_all_select" on public.posts;
  drop policy "allow_all_insert" on public.posts;
  -- Create a proper policy
  create policy "users_own_posts"
  on public.posts
  for select
  to authenticated
  using (user_id = auth.uid());
  -- 0 issues - proper policy
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test with anon role
  create table public.secrets(
    id int primary key,
    data text
  );
  alter table public.secrets enable row level security;
  create policy "bad_anon_policy"
  on public.secrets
  for select
  to anon
  using (true);
  -- 0 issues - SELECT with USING (true) is allowed even for anon
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test that policy for non-anon/authenticated role is not flagged
  drop policy "bad_anon_policy" on public.secrets;
  create role custom_role;
  create policy "custom_role_policy"
  on public.secrets
  for select
  to custom_role
  using (true);
  -- 0 issues - policy is for custom_role, not anon/authenticated
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test public (all roles) SELECT policy - should NOT be flagged
  drop policy "custom_role_policy" on public.secrets;
  create policy "public_policy"
  on public.secrets
  for select
  using (true);  -- applies to all roles by default
  -- 0 issues - SELECT with USING (true) is allowed
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test UPDATE with USING (true) - should be flagged
  drop policy "public_policy" on public.secrets;
  create policy "bad_update_policy"
  on public.secrets
  for update
  to authenticated
  using (true);
  -- 1 issue - UPDATE with USING (true) is dangerous
  select metadata->>'policy_name' as policy_name, metadata->>'command' as command from lint."0024_rls_policy_always_true";
    policy_name    | command 
-------------------+---------
 bad_update_policy | UPDATE
(1 row)

  -- Test DELETE with USING (true) - should be flagged
  drop policy "bad_update_policy" on public.secrets;
  create policy "bad_delete_policy"
  on public.secrets
  for delete
  to authenticated
  using (true);
  -- 1 issue - DELETE with USING (true) is dangerous
  select metadata->>'policy_name' as policy_name, metadata->>'command' as command from lint."0024_rls_policy_always_true";
    policy_name    | command 
-------------------+---------
 bad_delete_policy | DELETE
(1 row)

  drop policy "bad_delete_policy" on public.secrets;
  -- Test restrictive policy with true - should NOT be flagged (less dangerous)
  create policy "restrictive_true"
  on public.secrets
  as restrictive
  for select
  to authenticated
  using (true);
  -- 0 issues - restrictive policies are not flagged
  select * from lint."0024_rls_policy_always_true";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

rollback;
