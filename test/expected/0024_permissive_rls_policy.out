begin;
  set local search_path = '';
  set local pgrst.db_schemas = 'public';
  -- 0 issues - no tables yet
  select * from lint."0024_permissive_rls_policy";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Create a table with RLS enabled
  create table public.posts(
    id int primary key,
    user_id uuid,
    title text
  );
  alter table public.posts enable row level security;
  -- Create a permissive policy with USING (true) - should be flagged
  create policy "allow_all_select"
  on public.posts
  for select
  to authenticated
  using (true);
  -- 1 issue - policy with USING (true)
  select * from lint."0024_permissive_rls_policy";
         name          |         title         | level |  facing  | categories |                                                                                              description                                                                                              |                                                                                                     detail                                                                                                      |                                        remediation                                        |                                                                                                                 metadata                                                                                                                 |                      cache_key                      
-----------------------+-----------------------+-------+----------+------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------
 permissive_rls_policy | Permissive RLS Policy | WARN  | EXTERNAL | {SECURITY} | Detects RLS policies that use overly permissive expressions like \`USING (true)\` or \`WITH CHECK (true)\`, which effectively allow unrestricted access and may indicate a security misconfiguration. | Table `public.posts` has a permissive RLS policy `allow_all_select` for `SELECT` that allows unrestricted access (USING clause is always true). This effectively bypasses row-level security for authenticated. | https://supabase.com/docs/guides/database/database-linter?lint=0024_permissive_rls_policy | {"name": "posts", "qual": "true", "type": "table", "roles": ["authenticated"], "schema": "public", "command": "SELECT", "with_check": null, "policy_name": "allow_all_select", "permissive_using": true, "permissive_with_check": false} | permissive_rls_policy_public_posts_allow_all_select
(1 row)

  -- Create another policy with 1=1 tautology
  create policy "allow_all_insert"
  on public.posts
  for insert
  to authenticated
  with check (1=1);
  -- 2 issues
  select count(*) from lint."0024_permissive_rls_policy";
 count 
-------
     2
(1 row)

  -- Drop the bad policies
  drop policy "allow_all_select" on public.posts;
  drop policy "allow_all_insert" on public.posts;
  -- Create a proper policy
  create policy "users_own_posts"
  on public.posts
  for select
  to authenticated
  using (user_id = auth.uid());
  -- 0 issues - proper policy
  select * from lint."0024_permissive_rls_policy";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test with anon role
  create table public.secrets(
    id int primary key,
    data text
  );
  alter table public.secrets enable row level security;
  create policy "bad_anon_policy"
  on public.secrets
  for select
  to anon
  using (true);
  -- 1 issue - permissive policy for anon
  select metadata->>'policy_name' as policy_name, metadata->>'command' as command from lint."0024_permissive_rls_policy";
   policy_name   | command 
-----------------+---------
 bad_anon_policy | SELECT
(1 row)

  -- Test that policy for non-anon/authenticated role is not flagged
  drop policy "bad_anon_policy" on public.secrets;
  create role custom_role;
  create policy "custom_role_policy"
  on public.secrets
  for select
  to custom_role
  using (true);
  -- 0 issues - policy is for custom_role, not anon/authenticated
  select * from lint."0024_permissive_rls_policy";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

  -- Test public (all roles) policy - should be flagged
  drop policy "custom_role_policy" on public.secrets;
  create policy "public_policy"
  on public.secrets
  for select
  using (true);  -- applies to all roles by default
  -- 1 issue - policy applies to public
  select metadata->>'policy_name' as policy_name from lint."0024_permissive_rls_policy";
  policy_name  
---------------
 public_policy
(1 row)

  -- Test restrictive policy with true - should NOT be flagged (less dangerous)
  drop policy "public_policy" on public.secrets;
  create policy "restrictive_true"
  on public.secrets
  as restrictive
  for select
  to authenticated
  using (true);
  -- 0 issues - restrictive policies are not flagged
  select * from lint."0024_permissive_rls_policy";
 name | title | level | facing | categories | description | detail | remediation | metadata | cache_key 
------+-------+-------+--------+------------+-------------+--------+-------------+----------+-----------
(0 rows)

rollback;
